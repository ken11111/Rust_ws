# Phase 4.2 ä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025-12-31
**ç›®çš„**: Sync Word åŒæœŸãšã‚Œå•é¡Œã®ä¿®æ­£æ¤œè¨¼
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Phase 4.2 Bug Fix

---

## ğŸ“‹ ä¿®æ­£å†…å®¹ã®ã‚µãƒãƒª

### å®Ÿè£…ã•ã‚ŒãŸæ©Ÿèƒ½

1. **Sync Word è‡ªå‹•æ¢ç´¢** (`serial.rs:109-152`)
   - 1ãƒã‚¤ãƒˆãšã¤ã‚·ãƒ•ãƒˆã—ã¦ sync word 0xCAFEBABE ã‚’æ¢ç´¢
   - æœ€å¤§ 100KB ã¾ã§æ¢ç´¢ (å®‰å…¨è£…ç½®)
   - ç™ºè¦‹ã¾ã§ã®ãƒã‚¤ãƒˆæ•°ã‚’ãƒ­ã‚°å‡ºåŠ›

2. **è‡ªå‹•ã‚¨ãƒ©ãƒ¼å›å¾©** (`serial.rs:193-255`)
   - ãƒ‘ã‚±ãƒƒãƒˆè§£æã‚¨ãƒ©ãƒ¼æ™‚ã«è‡ªå‹•çš„ã« sync word ã‚’æ¢ç´¢
   - JPEG ãƒãƒ¼ã‚«ãƒ¼ (SOI/EOI) ã‚’æ¤œè¨¼
   - æœ€å¤§ 3 å›ã¾ã§è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
   - è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã§è¨ºæ–­å¯èƒ½

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„** (`gui_main.rs:355-476`)
   - `read_packet()` â†’ `read_packet_with_recovery()` ã«å¤‰æ›´
   - ã‚¨ãƒ©ãƒ¼å¾Œã« 10ms ã®å¾…æ©Ÿæ™‚é–“ã‚’è¿½åŠ 
   - ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

### æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ

| é …ç›® | Before (Buggy) | After (Fixed) | æ”¹å–„ç‡ |
|------|---------------|---------------|--------|
| **PC FPS** | 14.87 fps | 19-20 fps | +27-34% |
| **ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ç‡** | 43.5% | <1% | -97% |
| **ç´¯ç©ã‚¨ãƒ©ãƒ¼æ•°** | 114 å›/15åˆ† | <5 å›/15åˆ† | -95% |
| **Serial æ™‚é–“** | 68.27 ms | 48-50 ms | -27% |

---

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. åŸºæœ¬å‹•ä½œç¢ºèª (5åˆ†)

```bash
cd /home/ken/Rust_ws/security_camera_viewer

# ä¿®æ­£ç‰ˆã‚’å®Ÿè¡Œ
RUST_LOG=info ./target/release/security_camera_gui
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
- âœ… PC FPS ãŒ 19 fps ä»¥ä¸Š
- âœ… ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒ 5 å›ä»¥ä¸‹
- âœ… GUI ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã‚‹

### 2. 30åˆ†å‹•ä½œãƒ†ã‚¹ãƒˆ

```bash
# ãƒ­ã‚°ä»˜ãã§å®Ÿè¡Œ
RUST_LOG=info ./target/release/security_camera_gui 2>&1 | tee phase4_retest_$(date +%Y%m%d_%H%M%S).log
```

30åˆ†å¾Œã€Ctrl+C ã§åœæ­¢ã—ã¾ã™ã€‚

### 3. çµæœæ¤œè¨¼

```bash
# è‡ªå‹•æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
./test_validation.sh metrics/metrics_*.csv
```

**å‡ºåŠ›ä¾‹**:
```
===================================
Phase 4.2 Re-test Validation Report
===================================

CSV File: metrics/metrics_20251231_143022.csv

1. CSV Data Rows: 1823
   Expected: ~1800 rows (30 min Ã— 60 sec)

2. Average PC FPS: 19.87 fps
   Expected: 19.0-20.5 fps
   Previous (buggy): 14.87 fps
   âœ… PASS: FPS recovered to normal range

3. Cumulative Errors: 2
   Expected: < 10 errors
   Previous (buggy): 114 errors
   âœ… PASS: Error count within acceptable range

4. Decode Failures: 8 / 1823 (0.4%)
   Expected: < 1%
   Previous (buggy): 43.5%
   âœ… PASS: Decode failure rate dramatically improved

5. Average Serial Time: 49.23 ms
   Expected: 48-50 ms
   Previous (buggy): 68.27 ms
   âœ… PASS: Serial read time improved

6. Average JPEG Size: 53.45 KB
   Expected: ~53 KB

===================================
Overall Assessment:
===================================
ğŸ‰ ALL TESTS PASSED - Bug fix successful!

Performance Recovery:
  - PC FPS: 14.87 fps â†’ 19.87 fps (+33.6%)
  - Decode failures: 43.5% â†’ 0.4%
  - Errors: 114 â†’ 2

âœ… Ready to proceed to Phase 4.3: Error Recovery Test
===================================
```

---

## ğŸ” ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ­ã‚°ã®è¦‹æ–¹

### æ­£å¸¸å‹•ä½œæ™‚ (ã‚¨ãƒ©ãƒ¼ãªã—)

```
[INFO] Stats: PC FPS=19.9, Frames=20
[INFO] Stats: PC FPS=19.8, Frames=40
[INFO] Stats: PC FPS=20.1, Frames=60
```

### ã‚¨ãƒ©ãƒ¼å›å¾©ãŒå‹•ä½œã—ãŸæ™‚

```
[WARN] Packet parse error: Invalid sync word: expected 0xCAFEBABE, got 0x12CAFEBA
[INFO] Searching for sync word 0xCAFEBABE...
[INFO] Sync word found after reading 47 bytes
[INFO] Stats: PC FPS=19.7, Frames=82
```

**ã“ã‚Œã¯æ­£å¸¸ãªå‹•ä½œã§ã™**:
- ä¸€æ™‚çš„ãªãƒã‚¤ã‚ºã§ sync word ãŒãšã‚ŒãŸ
- è‡ªå‹•çš„ã« sync word ã‚’æ¢ç´¢ã—ã¦å›å¾©
- 47 ãƒã‚¤ãƒˆèª­ã¿é£›ã°ã—ã¦åŒæœŸã‚’å›å¾©
- ãã®å¾Œã€æ­£å¸¸å‹•ä½œãŒç¶™ç¶š

### JPEG ãƒãƒ¼ã‚«ãƒ¼ã‚¨ãƒ©ãƒ¼ã‹ã‚‰å›å¾©ã—ãŸæ™‚

```
[WARN] Invalid JPEG markers detected (no SOI/EOI)
[WARN]   First 4 bytes: [BE, BA, FE, CA]
[WARN]   Last 4 bytes: [12, 34, 56, 78]
[WARN] Attempting to resync...
[INFO] Searching for sync word 0xCAFEBABE...
[INFO] Sync word found after reading 153 bytes
```

**ã“ã‚Œã‚‚æ­£å¸¸ãªå‹•ä½œã§ã™**:
- CRC ã¯é€šéã—ãŸãŒã€JPEG ãƒãƒ¼ã‚«ãƒ¼ãŒå£Šã‚Œã¦ã„ãŸ
- è‡ªå‹•çš„ã« sync word ã‚’æ¢ç´¢ã—ã¦å›å¾©
- 153 ãƒã‚¤ãƒˆèª­ã¿é£›ã°ã—ã¦åŒæœŸã‚’å›å¾©

---

## âŒ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ 1: ä¾ç„¶ã¨ã—ã¦ FPS ãŒä½ã„ (< 19 fps)

**ç¢ºèªäº‹é …**:
```bash
# 1. Spresense ãŒ Phase 1.5 (VGA ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç‰ˆ) ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ç¢ºèª
# Spresense ã®ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš:
# "Camera thread started (priority 110)"
# "USB thread started (priority 100)"

# 2. USB ã‚±ãƒ¼ãƒ–ãƒ«ã®å“è³ªã‚’ç¢ºèª
lsusb -t | grep -A5 "054c:0bc2"

# 3. ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼å›å¾©ã®é »åº¦ã‚’ç¢ºèª
grep "Sync word found" phase4_retest_*.log | wc -l
```

**æœŸå¾…å€¤**:
- ã‚¨ãƒ©ãƒ¼å›å¾©ã¯ 1 æ™‚é–“ã« 5 å›ä»¥ä¸‹ãŒæ­£å¸¸
- 10 å›ä»¥ä¸Šç™ºç”Ÿã™ã‚‹å ´åˆã¯ USB ã‚±ãƒ¼ãƒ–ãƒ«ã¾ãŸã¯ãƒã‚¤ã‚ºæºã‚’ç–‘ã†

### å•é¡Œ 2: ä¾ç„¶ã¨ã—ã¦å¤šæ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**ç¢ºèªäº‹é …**:
```bash
# 1. æ­£ã—ã„ãƒã‚¤ãƒŠãƒªã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ç¢ºèª
./target/release/security_camera_gui --version 2>&1 | head -1

# 2. find_sync_word() ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
grep -n "find_sync_word" src/serial.rs
# 109è¡Œç›®ã«å®šç¾©ãŒã‚ã‚‹ã¯ãš

# 3. read_packet_with_recovery() ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèª
grep -n "read_packet_with_recovery" src/gui_main.rs
# 355è¡Œç›®ã§å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã¯ãš
```

### å•é¡Œ 3: "Sync word not found after 100000 bytes" ã‚¨ãƒ©ãƒ¼

**åŸå› **: Spresense ãŒé€ä¿¡ã‚’åœæ­¢ã—ã¦ã„ã‚‹å¯èƒ½æ€§

**è§£æ±ºç­–**:
```bash
# 1. Spresense ã‚’ãƒªã‚»ãƒƒãƒˆ
# 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
# 3. USB ã‚±ãƒ¼ãƒ–ãƒ«ã‚’äº¤æ›
```

---

## ğŸ“Š è©³ç´°åˆ†æ (Optional)

### FPS ã®æ™‚ç³»åˆ—å¤‰åŒ–ã‚’ç¢ºèª

```bash
awk -F',' 'NR>1 {print NR-1, $2}' metrics/metrics_*.csv | \
  gnuplot -e "set terminal dumb; set xlabel 'Time (sec)'; set ylabel 'FPS'; plot '-' with lines title 'PC FPS'"
```

### ãƒ‡ã‚³ãƒ¼ãƒ‰æ™‚é–“ã®åˆ†å¸ƒã‚’ç¢ºèª

```bash
awk -F',' 'NR>1 {print $5}' metrics/metrics_*.csv | sort -n | uniq -c | sort -rn | head -20
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:
```
   1780 2.3      # â† ã»ã¨ã‚“ã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒæ­£å¸¸ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
     15 2.4
     12 2.2
      8 2.5
      5 0.0       # â† ã‚ãšã‹ãªãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•— (< 1%)
      3 2.1
```

### ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç‰¹å®š

```bash
awk -F',' 'NR>1 && $4 > prev {print "Error at row", NR-1, "time", $1} {prev=$4}' metrics/metrics_*.csv
```

---

## âœ… åˆæ ¼åŸºæº–

### Phase 4.2 Re-test åˆæ ¼åŸºæº–

ä»¥ä¸‹ã®ã™ã¹ã¦ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™:

- âœ… **PC FPS**: 19.0-20.5 fps
- âœ… **ç´¯ç©ã‚¨ãƒ©ãƒ¼æ•°**: < 10 å› (30åˆ†é–“)
- âœ… **ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ç‡**: < 1%
- âœ… **Serial æ™‚é–“**: < 55 ms
- âœ… **GUI æ›´æ–°**: 30åˆ†é–“ç¶™ç¶šã—ã¦æ›´æ–°ã•ã‚Œã‚‹

### åˆæ ¼æ™‚ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 4.2 ãŒåˆæ ¼ã—ãŸã‚‰ã€ä»¥ä¸‹ã«é€²ã¿ã¾ã™:

1. **Phase 4.3: ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ†ã‚¹ãƒˆ** (15åˆ†)
   - USB ã‚±ãƒ¼ãƒ–ãƒ«æŠœãå·®ã—ãƒ†ã‚¹ãƒˆ
   - ãƒã‚¤ã‚ºè€æ€§ãƒ†ã‚¹ãƒˆ
   - ãƒªã‚»ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

2. **Phase 4.4: æ€§èƒ½ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°** (15åˆ†)
   - 1000 ãƒ•ãƒ¬ãƒ¼ãƒ è©³ç´°åˆ†æ
   - ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š

3. **Phase 4.5: Phase 4 å®Œäº†å ±å‘Šæ›¸ä½œæˆ**
   - å…¨ãƒ†ã‚¹ãƒˆçµæœã®ã¾ã¨ã‚
   - Phase 3.0 ã¨ã®æ¯”è¼ƒ

---

## ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã®è¨˜éŒ²

ãƒ†ã‚¹ãƒˆå®Ÿæ–½å¾Œã€ä»¥ä¸‹ã®æƒ…å ±ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„:

**ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ—¥æ™‚**: ____________________

**ãƒ†ã‚¹ãƒˆçµæœ**:

| é …ç›® | æ¸¬å®šå€¤ | åˆæ ¼/ä¸åˆæ ¼ |
|------|--------|------------|
| PC FPS | _____ fps | â˜ åˆæ ¼ â˜ ä¸åˆæ ¼ |
| ç´¯ç©ã‚¨ãƒ©ãƒ¼æ•° | _____ å› | â˜ åˆæ ¼ â˜ ä¸åˆæ ¼ |
| ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ç‡ | _____ % | â˜ åˆæ ¼ â˜ ä¸åˆæ ¼ |
| Serial æ™‚é–“ | _____ ms | â˜ åˆæ ¼ â˜ ä¸åˆæ ¼ |

**ã‚¨ãƒ©ãƒ¼å›å¾©ã®ç™ºç”Ÿå›æ•°**: _____ å› (ãƒ­ã‚°ã§ "Sync word found" ã‚’æ¤œç´¢)

**ç·åˆè©•ä¾¡**: â˜ åˆæ ¼ â˜ ä¸åˆæ ¼

**å‚™è€ƒ**:
_________________________________________________________________
_________________________________________________________________
_________________________________________________________________

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **ãƒã‚°å ±å‘Šæ›¸**: `PHASE4_BUG_REPORT.md`
- **Phase 4 ãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰**: `PHASE4_TEST_GUIDE.md`
- **ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ¸¬å®šã‚¬ã‚¤ãƒ‰**: `METRICS_GUIDE.md`
- **Spresense ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: `SPRESENSE_METRICS_PROTOCOL.md`

---

**ä½œæˆè€…**: Claude Code (Sonnet 4.5)
**ä½œæˆæ—¥**: 2025-12-31
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0 (Sync Word Bug Fix Version)
