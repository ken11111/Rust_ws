# Motion Detection Recording - Test Plan

## Phase 5 動き検知録画機能テスト計画

### 実装完了内容

✅ **リングバッファ実装** (`src/ring_buffer.rs`)
- 10秒分のJPEGフレームをメモリに保持
- 動き検知時に過去フレームをファイルに書き込み
- 23個のユニットテスト全て合格

✅ **動き検知アルゴリズム** (`src/motion_detector.rs`)
- フレーム差分法による動き検知
- グレースケール変換 → 差分計算 → 閾値処理
- 感度・最小動き領域・プリ/ポスト録画時間の設定可能
- 23個のユニットテスト全て合格

✅ **GUI統合** (`src/gui_main.rs`)
- 手動録画 (Phase 3) と動き検知録画 (Phase 5) の両対応
- リアルタイム設定変更UI
- 統計情報表示（検知率、バッファ状況）

---

## 1. 事前準備

### 1.1 ビルド確認

```bash
cd /home/ken/Rust_ws/security_camera_viewer
cargo build --release --features gui --bin security_camera_gui
```

**期待結果**:
```
Finished `release` profile [optimized] target(s) in X.XXs
```

### 1.2 実行ファイル確認

```bash
ls -lh target/release/security_camera_gui
```

**期待結果**: 約18MBの実行ファイルが存在

### 1.3 録画ディレクトリ確認

```bash
mkdir -p recordings
ls -ld recordings
```

---

## 2. 基本動作テスト

### Test 2.1: GUIアプリケーション起動

**手順**:
```bash
./target/release/security_camera_gui
```

**期待結果**:
- GUIウィンドウが正常に表示される
- 左側パネルに以下のセクションが表示される:
  - 📊 Performance Stats
  - 🎥 Recording
  - 🔍 Motion Detection
  - 📈 Spresense Metrics
  - 🎚️ Display Settings

**判定基準**: ✅ / ❌

---

### Test 2.2: Spresenseカメラ接続

**手順**:
1. Spresenseをシリアル接続
2. GUI上でシリアルポート選択
3. "Connect" ボタンクリック

**期待結果**:
- ステータスが "Connected" に変化
- カメラ映像がメインパネルに表示される
- FPS表示が更新される（約11fps）

**判定基準**: ✅ / ❌

---

## 3. 手動録画テスト（Phase 3機能の回帰テスト）

### Test 3.1: 手動録画開始/停止

**手順**:
1. "⏺ Start Rec" ボタンをクリック
2. 10秒間待機
3. "⏺ Stop Rec" ボタンをクリック

**期待結果**:
- 録画中に "🔴 MANUAL MM:SS | XX.XMB | XXX frames" と表示される
- `recordings/manual_YYYYMMDD_HHMMSS.mjpeg` ファイルが生成される
- ファイルサイズが約5-6MB（11fps × 10秒 × 55KB/frame）

**確認コマンド**:
```bash
ls -lh recordings/manual_*.mjpeg
```

**判定基準**: ✅ / ❌

---

### Test 3.2: 手動録画ファイル再生確認

**手順**:
```bash
ffplay recordings/manual_YYYYMMDD_HHMMSS.mjpeg
```

**期待結果**:
- 10秒間の映像が正常に再生される
- フレーム欠落やノイズがない

**判定基準**: ✅ / ❌

---

## 4. 動き検知録画テスト（Phase 5新機能）

### Test 4.1: 動き検知設定確認

**手順**:
1. "🔍 Motion Detection" セクションを確認
2. "Enable Motion Detection" チェックボックスをON
3. 以下の設定を確認:
   - Sensitivity: 50%（デフォルト）
   - Min Motion Area: 1.0%
   - Pre-record: 10秒
   - Post-record: 30秒

**期待結果**:
- 各スライダーが動作する
- リアルタイムで設定値が更新される
- 📊 Detection: X.X% が表示される
- 💾 Buffer: X/110 frames (X.X%) が表示される

**判定基準**: ✅ / ❌

---

### Test 4.2: リングバッファの蓄積確認

**手順**:
1. 動き検知をONにする
2. 静止状態で約15秒待機
3. バッファ状況を観察

**期待結果**:
- 💾 Buffer が徐々に増加（0/110 → 110/110 frames）
- 約10秒で100%に到達（11fps × 10秒 = 110 frames）
- ⏱️ Oldest: X.Xs ago が約10秒を維持

**判定基準**: ✅ / ❌

---

### Test 4.3: 動き検知トリガーテスト

**手順**:
1. 動き検知をON
2. バッファが100%になるまで静止
3. カメラ前で大きく手を振る
4. ステータス表示を確認

**期待結果**:
- 動き検知が発動し、録画が開始される
- ステータスが "🔴 MOTION MM:SS | XX.XMB | XXX frames | XXXf left" に変化
- `recordings/motion_YYYYMMDD_HHMMSS.mjpeg` ファイルが生成開始

**判定基準**: ✅ / ❌

---

### Test 4.4: プリバッファ確認（10秒前から録画）

**手順**:
1. 動き検知録画を実施（Test 4.3）
2. 録画停止後、ファイルを再生
3. 動きを検知した瞬間より前の映像を確認

**期待結果**:
- 動きを検知した瞬間より約10秒前から録画されている
- プリバッファ部分も正常に再生される

**再生コマンド**:
```bash
ffplay recordings/motion_YYYYMMDD_HHMMSS.mjpeg
```

**判定基準**: ✅ / ❌

---

### Test 4.5: ポストバッファ確認（30秒後まで録画）

**手順**:
1. 動き検知録画を開始
2. 5秒間動いた後、静止する
3. ステータス表示を観察
4. 約30秒待機

**期待結果**:
- 動きを止めた後、ステータスが "⏱️ POST" に変化
- "XXXf left" のカウントダウンが開始（330 → 0）
- カウント0で自動的に録画停止
- 録画時間が約45秒（プリ10秒 + 動き5秒 + ポスト30秒）

**判定基準**: ✅ / ❌

---

### Test 4.6: 動き継続時のカウントダウンリセット

**手順**:
1. 動き検知録画開始
2. 5秒動いた後、静止（ポストモード開始）
3. カウントダウンが200f付近で再度動く
4. ステータスを確認

**期待結果**:
- 再度動くと "🔴 MOTION" に戻る
- カウントダウンが330fにリセットされる
- 動きが連続する限り録画継続

**判定基準**: ✅ / ❌

---

## 5. 設定変更テスト

### Test 5.1: 感度（Sensitivity）変更

**手順**:
1. Sensitivity を 0%（超高感度）に設定
2. 小さな動き（指を動かす程度）でテスト
3. Sensitivity を 100%（低感度）に設定
4. 大きな動き（全身を動かす）でテスト

**期待結果**:
- 0%: 小さな動きで検知される（検知率が高い）
- 100%: 大きな動きのみ検知される（検知率が低い）
- 📊 Detection: X.X% が変化する

**判定基準**: ✅ / ❌

---

### Test 5.2: 最小動き領域（Min Motion Area）変更

**手順**:
1. Min Motion Area を 0.1%に設定（非常に小さい領域でOK）
2. 画面の一部で小さく手を振る
3. Min Motion Area を 10.0%に設定（広い領域が必要）
4. 画面全体で動く

**期待結果**:
- 0.1%: 小さな領域の動きで検知される
- 10.0%: 広い領域の動きが必要

**判定基準**: ✅ / ❌

---

### Test 5.3: プリ録画時間（Pre-record）変更

**手順**:
1. Pre-record を 5秒に設定
2. バッファが満杯になるまで待機（約5秒）
3. 💾 Buffer が 55/55 frames になることを確認
4. Pre-record を 30秒に設定
5. 💾 Buffer が 330/330 frames になることを確認

**期待結果**:
- バッファ容量が動的に変更される
- Pre-record秒数 × 11fps = バッファフレーム数

**判定基準**: ✅ / ❌

---

### Test 5.4: ポスト録画時間（Post-record）変更

**手順**:
1. Post-record を 10秒に設定
2. 動き検知録画を開始し、すぐに静止
3. カウントダウンが110f（10秒×11fps）から開始することを確認
4. Post-record を 60秒に設定
5. カウントダウンが660fから開始することを確認

**期待結果**:
- ポスト録画時間が設定通りに変更される

**判定基準**: ✅ / ❌

---

## 6. 並列動作テスト

### Test 6.1: 手動録画中の動き検知無視

**手順**:
1. "⏺ Start Rec" で手動録画を開始
2. 動き検知をON
3. カメラ前で動く
4. ステータス表示を確認

**期待結果**:
- 手動録画が継続（"🔴 MANUAL" 表示のまま）
- 動き検知録画は開始されない（手動録画が優先）

**判定基準**: ✅ / ❌

---

### Test 6.2: 動き検知録画中の手動停止

**手順**:
1. 動き検知録画を開始
2. "⏺ Stop Rec" ボタンをクリック
3. ファイル生成を確認

**期待結果**:
- 動き検知録画が即座に停止される
- 途中までの録画ファイルが保存される

**判定基準**: ✅ / ❌

---

## 7. 長時間運転テスト

### Test 7.1: 連続動作テスト（30分）

**手順**:
1. 動き検知をON
2. 30分間放置（時々動きを入れる）
3. メモリ使用量を監視

**期待結果**:
- アプリケーションがクラッシュしない
- メモリリークがない（使用量が一定範囲内）
- 複数の動き検知録画ファイルが生成される

**監視コマンド**:
```bash
top -p $(pgrep security_camera_gui)
```

**判定基準**: ✅ / ❌

---

### Test 7.2: ファイルサイズ制限テスト（2GB）

**手順**:
1. 動き検知録画を開始
2. 長時間動き続ける（約30分以上）
3. 2GB到達時の動作を確認

**期待結果**:
- 2GB到達時に自動的に録画停止
- ログに "Recording size limit reached" 警告

**判定基準**: ✅ / ❌

---

## 8. エラーハンドリングテスト

### Test 8.1: ディスク容量不足

**手順**:
1. 録画ディレクトリのディスク使用率を確認
2. 容量不足時の動作を観察

**期待結果**:
- エラーログが出力される
- アプリケーションがクラッシュしない

**判定基準**: ✅ / ❌

---

### Test 8.2: カメラ切断時の動作

**手順**:
1. 動き検知録画中にSpresenseを物理的に切断
2. アプリケーションの反応を確認

**期待結果**:
- 録画が停止される
- 部分的な録画ファイルが保存される
- エラーメッセージが表示される

**判定基準**: ✅ / ❌

---

## 9. パフォーマンステスト

### Test 9.1: フレームレート影響確認

**手順**:
1. 動き検知OFF時のFPSを記録（約11fps期待）
2. 動き検知ON時のFPSを記録
3. FPS低下を計算

**期待結果**:
- FPS低下が約8%以内（仕様書通り）
- 動き検知ON: 約10.1fps以上
- 動き検知OFF: 約11.0fps

**判定基準**: ✅ / ❌

---

### Test 9.2: メモリ使用量確認

**手順**:
```bash
# 起動前
free -h

# 起動後（動き検知OFF）
ps aux | grep security_camera_gui

# 動き検知ON（バッファ満杯時）
ps aux | grep security_camera_gui
```

**期待結果**:
- ベースメモリ: 約200MB
- バッファ追加: +6.7MB（仕様書通り）
- 合計: 約207MB以内

**判定基準**: ✅ / ❌

---

## 10. テスト結果サマリー

### 基本動作テスト
- [ ] Test 2.1: GUI起動
- [ ] Test 2.2: カメラ接続

### 手動録画テスト
- [ ] Test 3.1: 手動録画開始/停止
- [ ] Test 3.2: ファイル再生確認

### 動き検知録画テスト
- [ ] Test 4.1: 設定確認
- [ ] Test 4.2: リングバッファ蓄積
- [ ] Test 4.3: 動き検知トリガー
- [ ] Test 4.4: プリバッファ確認
- [ ] Test 4.5: ポストバッファ確認
- [ ] Test 4.6: カウントダウンリセット

### 設定変更テスト
- [ ] Test 5.1: 感度変更
- [ ] Test 5.2: 最小動き領域変更
- [ ] Test 5.3: プリ録画時間変更
- [ ] Test 5.4: ポスト録画時間変更

### 並列動作テスト
- [ ] Test 6.1: 手動録画中の動き検知無視
- [ ] Test 6.2: 動き検知録画中の手動停止

### 長時間運転テスト
- [ ] Test 7.1: 連続動作テスト（30分）
- [ ] Test 7.2: ファイルサイズ制限テスト

### エラーハンドリングテスト
- [ ] Test 8.1: ディスク容量不足
- [ ] Test 8.2: カメラ切断時の動作

### パフォーマンステスト
- [ ] Test 9.1: フレームレート影響確認
- [ ] Test 9.2: メモリ使用量確認

---

## 11. 次フェーズ: MP4録画対応（Phase 6予定）

現在の実装ではMJPEG形式で録画されます。MP4対応は別フェーズとして実装予定です。

**MP4_RECORDING_SPEC.md** を参照してください。

---

## 補足

### ログ確認

実行時のログは環境変数で制御できます:

```bash
RUST_LOG=debug ./target/release/security_camera_gui
```

レベル:
- `error`: エラーのみ
- `warn`: 警告以上
- `info`: 情報以上（デフォルト）
- `debug`: デバッグ情報
- `trace`: 全ての詳細ログ

### トラブルシューティング

**問題**: GUIが起動しない
**解決策**: X11またはWaylandディスプレイサーバーが動作しているか確認

**問題**: カメラ映像が表示されない
**解決策**: Spresenseのシリアルポート権限を確認（`sudo usermod -aG dialout $USER`）

**問題**: 動き検知が反応しない
**解決策**: Sensitivityを0%（超高感度）に設定してテスト

**問題**: 録画ファイルが再生できない
**解決策**: ffmpegがインストールされているか確認（`sudo apt install ffmpeg`）

---

**テスト実施日**: __________
**テスト担当者**: __________
**ビルドバージョン**: __________
